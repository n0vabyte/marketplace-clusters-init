---
# Removes keys when debug is not passed. 
# Requires that a provisioner group exist in the hosts inv
# Example:
#
# [provisioner]
# localhost ansible_connection=local user=root
#
# keys will always exist on localhost.

- name: Remove provisioner from authorized_keys
  lineinfile:
    dest: /root/.ssh/authorized_keys
    state: absent
    regexp: '^.+ansible$'
  run_once: true
  delegate_to: "{{ item }}"
  loop: "{{ groups ['provisioner'] }}"
  when: debug is undefined

- name: Remove provisioner ssh keys
  file:
    path: '{{ item }}'
    state: absent
  run_once: true
  delegate_to: localhost
  loop:
    - '{{ ansible_env.HOME }}/.ssh/id_ansible_ed25519'
    - '{{ ansible_env.HOME }}/.ssh/id_ansible_ed25519.pub'
  when: debug is undefined